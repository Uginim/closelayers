<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <canvas id = "map" width="256px" height="256px" style="outline: 1px solid red;">
        
    </canvas>
    <!-- https://en.wikipedia.org/wiki/Web_Mercator_projection -->
</body>
    <script>
        // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage#JavaScript_2
        var image = new Image ();
        image.src = "https://a.tile.openstreetmap.org/0/0/0.png";
        image.onload = drawImageActualSize; // Draw when image has loaded
        function drawImageActualSize() {
            var canvas = document.getElementById('map');
            canvas.width = this.naturalWidth;
            canvas.height = this.naturalHeight;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(this, 0, 0);
            ctx.drawImage(this, 0, 0, this.width, this.height);
        }

        window.addEventListener('load',function(){
            var canvas = document.getElementById('map');
            console.log("canvas:",canvas);
            console.dir(canvas);
            var context = canvas.getContext('2d');
            var zoomLevel = 0;
            var λ = 127 /180 * Math.PI;
            var φ =  38 /180 * Math.PI;
            var MAX_φ = (2 * Math.atan(Math.pow(Math.E ,Math.PI)) - Math.PI/2) * 180 /Math.PI;
            var x = Math.floor(256 / ( 2 * Math.PI ) * Math.pow(2,zoomLevel) * ( λ + Math.PI));
            var y = 256 / ( 2 * Math.PI ) * Math.pow(2,zoomLevel) * ( Math.PI - Math.log(Math.tan(Math.PI/4 + φ/2)));
            console.log("x,y",x,y);
            context.fillStyle = "rgb(200,0,0)";
            context.fillRect (x-2, y-2, 5, 5);
        });
        
        function TileLoader(){
            
        }
        /** 
         * 해당하는 타일 이미지의 URL을 생성함
         * 
         */
        TileLoader.prototype.getOSMTileImageUrl = function(zoomLevel, xIdx, yIdx){
            if( !zoomLevel || !xIdx || !yIdx)
                throw new Error();
            return `https://a.tile.openstreetmap.org/${zoomLevel}/${xIdx}/${yIdx}.png`;
        }

        function MapView(){

        }
        MapView.prototype.setTileImage() = function (zoomLevel, widthOfView, heightOfView){

        }

        
        MapView.prototype.getViewExtentXY() = function (){
            
        }

        MapView.prototype.setZoomLevel() = function (newZoomLevel){
            this._ZoomLevel = newZoomLevel;
            this.viewRefresh();
        }


        /**
         * 
         */
        function Projection(){
            
        }


        Projection.prototype.transformXYToLatLonWithWebMercator =  
            function transformXYToLatLonWithWebMercator(zoomLevel, x, y){
            const λ = x / 256 * (2*Math.PI) / Math.pow(2,zoomLevel) - Math.PI;
            const φ = 2 *  Math.atan( Math.pow ( Math.E,  Math.PI - y / 256 * (2 * Math.PI) / Math.pow(2,zoomLevel) ) ) - Math.PI/2;
            const lat = φ * 180 / Math.PI;
            const lon = λ * 180 / Math.PI; 
            return {lat,lon} 
        };
                
        /**
         * Web Mercator의 투영방식으로 위경도 좌표를 x,y좌표로 변환함
         */
        Projection.prototype.transformLatLonToXYWithWebMercator =  
            function transformLatLonToXYWithWebMercator(zoomLevel, Lat, Lon ){
            var λ = Lon /180 * Math.PI;
            var φ = Lat /180 * Math.PI;
            var x = Math.floor(256 / ( 2 * Math.PI ) * Math.pow(2,zoomLevel) * ( λ + Math.PI));
            var y = Math.floor(256 / ( 2 * Math.PI ) * Math.pow(2,zoomLevel) * ( Math.PI - Math.log(Math.tan(Math.PI/4 + φ/2))));
            return {x,y};
        };



    </script>
</html>